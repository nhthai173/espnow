<!doctypehtml><html lang=en><meta charset=UTF-8><meta content=width=device-width,initial-scale=1.0 name=viewport><title>Devices</title><link crossorigin href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css integrity=sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH rel=stylesheet><link href=https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/css/all.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/notiflix@3.2.7/src/notiflix.min.css rel=stylesheet><style>.form-check-input{width:2.5em!important;height:1.3em!important}.form-control[type=text]{width:auto;max-width:50%}.nav-link{color:#0006}</style><body><nav class="navbar bg-body-tertiary fixed-top"><div class=container-fluid><div class="navbar-brand fs-4"><button class=navbar-toggler data-bs-target=#offcanvasNavbar data-bs-toggle=offcanvas type=button><span class=navbar-toggler-icon></span></button><span class=ms-3>Devices</span></div><div class="offcanvas offcanvas-start"id=offcanvasNavbar tabindex=-1><div class=offcanvas-header><h5 class="offcanvas-title fs-4">Menu</h5><button aria-label=Close class=btn-close data-bs-dismiss=offcanvas type=button></button></div><div class=offcanvas-body><ul class="navbar-nav justify-content-end flex-grow-1 pe-3 fs-5"><li class=nav-item><a aria-current=page class=nav-link href=/>Home</a><li class=nav-item><a class="nav-link active"href=/devices>Devices</a></ul></div></div><div><button class="btn btn-outline-secondary"action=startPairing>Add device</button></div></div></nav><div class="modal fade"aria-hidden=true data-bs-backdrop=static data-bs-keyboard=false id=pairModal tabindex=-1><div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down"><div class=modal-content><div class=modal-header><h1 class="modal-title fs-5"id=exampleModalLabel>Pairing</h1></div><div class="modal-body p-5"><div class="d-flex justify-content-center progress bg-transparent"style=height:250px></div><div class="d-flex justify-content-center mt-5 mb-3"><button class="btn btn-lg btn-danger d-none"action=stopPairing>Stop</button></div></div></div></div></div><div class=container-fluid style=margin-top:60px><div class="row py-4"id=main><div class="col-12 col-node-empty d-flex justify-content-center align-items-center d-none"style="height:calc(100vh - 100px)"><img height=auto src=https://i.imgur.com/LBk6ESa.png width=300px></div></div></div><script crossorigin integrity=sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js></script><script src=https://cdn.jsdelivr.net/npm/notiflix@3.2.7/dist/notiflix-aio-3.2.7.min.js></script><script src=https://cdn.jsdelivr.net/npm/circular-progress-bar@2.1.0/public/circular-progress-bar.min.js></script><script>const enurl=encodeURIComponent;const {Loading,Confirm}=Notiflix;Confirm.init({width:`400px`,titleColor:`#0d6efd`,okButtonBackground:`#0d6efd`,titleFontSize:`1.3em`,messageFontSize:`1em`,buttonFontSize:`1em`});Loading.init({svgColor:`#fff`});Notiflix.Notify.init({useFontAwesome:!0,timeout:10000,width:`350px`,fontSize:`1.1em`});const $main=document.getElementById(`main`);const emptyNode=()=>{$main.querySelector(`.col-node-empty`).classList.remove(`d-none`)};const notify=(a,...b)=>{Notiflix.Notify[a](b.join(` `))};const alertReload=(a=`Error`,b=``)=>{Confirm.show(a,b,`Reload`,`Close`,()=>{location.reload()})};const parseProp=a=>{let e=``,g=`string`,f=1;let b=e;let c=e;const d=a.indexOf(`,`);if(d>-f){b=a.substring(0,d);const c=a.substring(d+ f);let e=null;try{e=JSON.parse(c)}catch(a){}if(e)return {v:b,...e};return {v:a,type:g}};if(a===`true`||a===`false`)c=`bool`;else if(!isNaN(a))c=`number`;else c=g;return {v:a,type:c}};const propHTML=a=>{let f=``,g=`number`;const b=()=>`<span>${a.name||a.id}${a.name?` <span class=\\"text-muted\\">`+ a.id+ `</span>`:f}</span>`;const c=()=>`<div class="ms-auto form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" action="setProp" prop="${a.id}" ${a.v===`true`?`checked`:f}></div>`;const d=()=>`<input class="ms-auto form-control text-end" type="text" action="setProp" prop="${a.id}" value="${a.v}" ${a.type==g?`pattern="\\d*"`:f}>`;let e=`<div class="d-flex align-items-center mb-3">`+ b();switch(a.type){case `bool`:e+=c();break;case g:;case `string`:e+=d();break}e+=`</div>`;return e};const nodeCard=a=>{const {name:b,did:c,id:d,props_name:e}=a;const f=e.split(`,`).map(b=>({id:b,...parseProp(a[b])}));const g=document.createElement(`div`);g.className=`col-12 col-md-6 col-lg-4 col-xxl-3 col-node my-3`;g.setAttribute(`did`,c);g.innerHTML=`<div class="card">
                <div class="card-header d-flex align-items-center fs-4 mb-3">
                    <span>${b}</span>
                    <span class="text-muted fs-6 ms-2">${d}</span>
                    <div class="ms-auto pointer" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></div>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" action="deviceDetail" href="#"><i class="fal fa-info-circle me-2"></i><span>Detail</span></a>
                        <a class="dropdown-item" action="syncProps" href="#"><i class="fal fa-cloud-download me-2"></i><span>Sync</span></a>
                        <a class="dropdown-item" action="restartDevice" href="#"><i class="fal fa-sync me-2"></i><span>Restart</span></a>
                        <a class="dropdown-item text-danger" action="unpairDevice" href="#"><i class="far fa-unlink me-2"></i><span>Unpair</span></a>
                    </div>
                </div>    
                <div class="card-body fs-5">${f.map(propHTML).join(``)}</div>
            </div>`;$main.appendChild(g)};const json2query=a=>Object.keys(a).map(b=>enurl(b)+ `=`+ enurl(a[b])).join(`&`);const setProp=(a,b,c)=>{let e=`failure`;const d=`/command?`+ json2query({id:a,action:`set_prop`,params:`${b},${c}`});console.log(`GET`,d);fetch(d).then(a=>a.json()).then(d=>{console.log(d);if(d.success===!0)notify(`success`,`[${a}/${b}] changed to [${c}]`);else notify(e,`Change [${a}/${b}] failed: ${d.message}`)}).catch(c=>{notify(e,`Change [${a}/${b}] failed: ${c.message}`)})}</script><script>const Pairing={$stopBtn:document.querySelector(`#pairModal button[action="stopPairing"]`),progress:null,setRemaining:(a,b)=>{let c=Math.round(a/b*100);console.log(a,b,c);Pairing.progress.value=c;document.querySelector(`#pairModal .circular-progress-bar_value_text`).innerHTML=`${a}s`},show:(a,b)=>{new bootstrap.Modal(`#pairModal`).show();Pairing.progress=new CircularProgressBar(100,{size:250,background:`transparent`,showValue:!1});Pairing.progress.appendTo(document.querySelector(`#pairModal .progress`));Pairing.setRemaining(a,b);Pairing.$stopBtn.classList.remove(`d-none`);let c=setInterval(()=>{Pairing.getRemaining(a=>{if(a.remaining>0){Pairing.setRemaining(a.remaining,a.timeout)}else{clearInterval(c);Pairing.hide();setTimeout(()=>location.reload(),500)}})},1000)},hide:()=>{Loading.remove();document.querySelector(`#pairModal .progress`).innerHTML=``;bootstrap.Modal.getInstance(`#pairModal`)?.hide();Pairing.$stopBtn.classList.add(`d-none`)},start:()=>{let a=`failure`;Loading.circle();fetch(`/pair?start`).then(a=>a.json()).then(b=>{Loading.remove();if(b.success){Pairing.show(b.remaining,b.timeout)}else{notify(a,b.message)}}).catch(b=>{Loading.remove();notify(a,b.message)})},stop:()=>{let a=`failure`;Loading.circle();fetch(`/pair?stop`).then(a=>a.json()).then(b=>{Pairing.hide();if(b.success){Pairing.hide()}else{notify(a,b.message)}}).catch(b=>{Pairing.hide();notify(a,b.message)})},getRemaining:a=>{fetch(`/pair`).then(a=>a.json()).then(b=>{console.log(b);if(a){a(b);return};if(b.remaining>0){Pairing.show(b.remaining,b.timeout)}else{Pairing.hide()}}).catch(a=>{notify(`failure`,a.message)})}}</script><script>document.body.addEventListener(`click`,a=>{let e=`deviceDetail`,d=`action`,f=`info`,i=`unpairDevice`,g=`syncProps`,h=`restartDevice`;const b=a.target;let c=b.getAttribute(d);if(!c)c=b.closest(`.dropdown-item`)?.getAttribute(d);if(c){const a=b.closest(`.col-node`)?.getAttribute(`did`);const d=b.getAttribute(`prop`)||``;switch(c){case e:notify(f,e,a);break;case g:notify(f,g,a);break;case h:notify(f,h,a);break;case i:notify(f,i,a);break;case `startPairing`:Pairing.start();break;case `stopPairing`:Pairing.stop();break;case `setProp`:if(b.tagName===`INPUT`&&b.type===`text`)break;notify(f,`Change [${a}/${d}] to [${b.checked}]`);setProp(a,d,b.checked);break}}});document.body.addEventListener(`change`,a=>{const b=a.target;if(b.tagName===`INPUT`&&b.type===`text`&&b.getAttribute(`action`)===`setProp`){const a=b.closest(`.col-node`)?.getAttribute(`did`);const c=b.getAttribute(`prop`);b.blur();notify(`info`,`Change [${a}/${c}] to [${b.value}]`);setProp(a,c,b.value)}})</script><script>var Devices=[];Loading.circle();Pairing.getRemaining();fetch(`/devices`,{method:`POST`}).then(a=>a.json()).then(a=>{Loading.remove();console.log(a);Devices=a;Devices.forEach(nodeCard);if(!a.length)emptyNode()}).catch(a=>{Loading.remove();alertReload(`Error fetch devices`,a.message);emptyNode()})</script>