<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/hung1001/font-awesome-pro@4cac1a6/css/all.css" rel="stylesheet"
        type="text/css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notiflix@3.2.7/src/notiflix.min.css">
    <link rel="stylesheet" href="./style.css">
    <style>
        .card-at {
            cursor: pointer;
            transition: all 0.3s;
        }

        .form-check-lg .form-check-input {
            width: 3.5em !important;
            height: 1.7em !important;
        }

        .select-lg {
            cursor: pointer;
            position: relative;
        }

        .select-lg::after {
            font-family: "Font Awesome 5 Pro";
            content: "\f078";
            font-size: 1.5em;
            opacity: 0.5;
            font-weight: lighter;
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }

        .select-option {
            display: none;
        }

        .select-option[selected] {
            display: block;
        }

        .form-none {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            background-color: transparent !important;
        }

        .at-title {
            font-size: 1.75em;
            font-weight: 500;
            margin-top: 0.4em;
            margin-bottom: 0.7em;
        }

        .at-item {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1em;
        }

        .at-item .index {
            width: 40px;
            text-align: center;
            margin-right: 0.4em;
            color: var(--muted-light);
            font-size: 1.5em;
        }

        .at-item .title {
            font-size: 1.5em;
        }

        .at-item .subtitle {
            color: var(--muted-light);
        }

        .at-item.at-edit::after {
            font-family: "Font Awesome 5 Pro";
            content: "\f054";
            font-size: 1.2em;
            font-weight: lighter;
            opacity: 0.5;
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
        }

        .at-item.at-new {
            padding-top: 0.6em;
        }

        .at-item.at-new,
        .at-item.at-new .index {
            color: rgb(var(--bs-primary-rgb));
        }


        
    </style>
</head>

<body>

    <!-- Nav -->
    <nav class="navbar main-navbar bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <div class="navbar-brand fs-4">
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <span class="ms-1 ms-md-3">Automations</span>
            </div>
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title fs-4">Menu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3 fs-5">
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="./">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./devices.html">Devices</a>
                        </li>
                        <li>
                            <a class="nav-link active" href="./automations.html">Automations</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div action="addAT">
                <div class="d-none d-md-block">
                    <button class="btn btn-outline-secondary">Add new automation</button>
                </div>    
                <div class="d-block d-md-none">
                    <a href="#" class="text-white rounded-pill me-2" action="addAT"><i class="fs-4 fal fa-plus-circle"></i></a>
                </div>
            </div>
        </div>
    </nav>







    <!-- Edit automation modal -->
    <div class="modal fade" id="atEditModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="btn btn-icon fs-4" action="atDiscard">
                        <i class="fal fa-times" action="atDiscard"></i>
                    </button>
                    <button class="ms-auto btn btn-icon fs-4" action="atSave">
                        <i class="fal fa-check" action="atSave"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <h3 class="at-title" role="title"></h3>
                    <div class="card card-1">
                        <div class="card-body">
                            <input class="fs-5 w-100 form-none" type="text" placeholder="Automation name" name="atName">
                        </div>
                    </div>
                    <div class="mt-5 mb-4">
                        <div class="select-lg" data-bs-toggle="dropdown" name="atMatchType">
                            <h3 class="select-option at-title" value="0" selected>When any of situations occur</h3>
                            <h3 class="select-option at-title" value="1">When all of situations occur</h3>
                        </div>
                    </div>

                    <div class="card card-1" at-type="trigger">
                        <div class="card-body pointer">
                            <div class="at-item at-new">
                                <div class="index">
                                    <i class="fal fa-plus"></i>
                                </div>
                                <span>Add a trigger condition</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 mb-4">
                        <h3 class="at-title">Adjust the devices to</h3>
                    </div>

                    <div class="card card-1" at-type="action">
                        <div class="card-body pointer">
                            <div class="at-item at-new">
                                <div class="index">
                                    <i class="fal fa-plus"></i>
                                </div>
                                <span>Add an action</span>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center mt-5 mb-3">
                        <button class="btn btn-lg btn-outline-danger rounded-pill w-100" action="atDelete">
                            Delete automation
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>







    <!-- Edit item modal -->
    <div class="modal fade" id="atEditItemModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="btn btn-icon fs-4" action="atDiscard">
                        <i class="fal fa-times" action="atDiscard"></i>
                    </button>
                    <button class="ms-auto btn btn-icon fs-4" action="atSave">
                        <i class="fal fa-check" action="atSave"></i>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <h3 role="title" class="at-title"></h3>

                    <div class="mt-5">
                        <h3 class="at-title">Device</h3>
                    </div>
                    <div class="card card-1">
                        <div class="card-body pointer">
                            <select class="form-select form-select-lg form-none" name="did"></select>
                        </div>
                    </div>

                    <div class="mt-5">
                        <h3 class="at-title">Property</h3>
                    </div>
                    <div class="card card-1">
                        <div class="card-body pointer">
                            <select class="form-select form-select-lg form-none" name="prop"></select>
                        </div>
                    </div>

                    <div class="mt-5">
                        <h3 class="at-title">Value</h3>
                    </div>
                    <div class="card card-1">
                        <div class="card-body">
                            <input class="fs-5 my-2 w-100 form-none" type="text" name="value">
                        </div>
                    </div>

                    <div class="d-flex justify-content-center mt-5 mb-3">
                        <button class="btn btn-lg btn-outline-danger rounded-pill w-100"
                            action="atDelete">Delete</button>
                    </div>

                </div>
            </div>
        </div>
    </div>



    <div class="container-fluid" style="margin-top: 60px;">
        <div class="row justify-content-center py-4 px-2">
            <div class="col py-5" id="main" style="width: 100%; max-width: 600px;">



                <!-- <div class="card card-at border-0 shadow rounded-4 mb-5" at-id="">
                    <div class="card-body d-flex align-items-center p-4">
                        <span class="fs-4 fw-medium">{name}</span>
                        <div class="ms-auto form-check form-check-lg form-switch">
                            <input class="form-check-input" type="checkbox" action="atEnableToggle">
                        </div>
                    </div>
                </div> -->



            </div>

        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/notiflix@3.2.7/dist/notiflix-aio-3.2.7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/circular-progress-bar@2.1.0/public/circular-progress-bar.min.js"></script>
    <script src="./utils.js"></script>



    <script>

        baseURI = ''
    </script>



    <script>
        var Devices = [
            {
                "did": "5922554",
                "mac": "40:91:51:5a:5e:fa",
                "id": "5922554",
                "name": "Node1",
                "type": "ESP8266",
                "model": "security-board",
                "fw_ver": "1",
                "support": "get_props,get_prop,set_prop",
                "props_name": "led,button",
                "led": "false",
                "button": "idle"
            }
        ]

        var Automations = [
            // {
            //     id: 123,
            //     enabled: true,
            //     name: 'Automation 1',
            //     matchType: 0,
            //     triggers: [
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'button', value: 'click' },
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'led', value: 'false' }
            //     ],
            //     actions: [
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'led', value: 'true' },
            //     ]
            // },
            // {
            //     id: 124,
            //     enabled: true,
            //     name: 'Automation 2',
            //     matchType: 1,
            //     triggers: [
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'button', value: 'click' },
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'led', value: 'true' }
            //     ],
            //     actions: [
            //         { type: '2', did: '5922554', dname: 'Node 1', prop: 'led', value: 'false' },
            //     ]
            // }
        ]



        class ATModal {
            static currentModal = null

            static init() {
                document.body.addEventListener('click', (e) => {
                    const el = e.target
                    const action = el.getAttribute('action')
                    switch (action) {
                        case 'atDiscard':
                            Confirm.show('Discard', 'Are you sure you want to discard changes?', 'Discard', 'Cancel', () => {
                                ATModal.currentModal?.discard()
                            })
                            break
                        case 'atSave':
                            ATModal.currentModal?.save()
                            break
                        case 'atDelete':
                            Confirm.show('Delete', 'Are you sure you want to delete this?', 'Delete', 'Cancel', () => {
                                ATModal.currentModal?.delete()
                            })
                            break
                    }
                })

                try {
                    ATEdit.init()
                    ATEditItem.init()
                } catch (e) { }

            }
        }

        class ATEditItem extends ATModal {

            static init() {
                document.querySelectorAll("#atEditItemModal [name]").forEach(el => {
                    el.addEventListener('change', () => {
                        const name = el.getAttribute('name')
                        if (name === 'did') {
                            ATModal.currentModal?._selectDevice(el.value)
                            ATModal.currentModal?._intPropsSelect()
                        }
                    })
                })
            }

            constructor(type, action, data) {
                super()
                ATModal.currentModal = this

                this.modal = document.getElementById('atEditItemModal')
                this.data = data
                this.action = action
                this.$devices = this.modal.querySelector('[name="did"]')
                this.$props = this.modal.querySelector('[name="prop"]')
                this.$value = this.modal.querySelector('[name="value"]')
                this.$delBtn = this.modal.querySelector('[action="atDelete"]')

                this.titleText = action.charAt(0).toUpperCase() + action.slice(1)
                this.titleText += ` ${type}`
                this.deleteText = `Delete ${type}`
                this.modal.querySelector('[role="title"]').innerHTML = this.titleText
                this.$delBtn.innerHTML = this.deleteText

                this._selectDevice(this.data.did)
                this.$devices.dispatchEvent(new Event('change'))
                this._intPropsSelect()
                this._propSelect(this.data.prop)
                this.$value.value = this.data.value || ""

                if (action === 'edit') {
                    this.$devices.disabled = true
                    this.$delBtn.style.display = 'block'
                } else {
                    this.$devices.disabled = false
                    this.$delBtn.style.display = 'none'
                }

                // @TODO support all type
                this.data.atType = '2'

                new bootstrap.Modal(this.modal).show()
            }

            destroy() {
                ATModal.currentModal = null
                bootstrap.Modal.getInstance(this.modal)?.hide()
                this.data.previousModal?.handleItemAction(this.data)
            }

            _initDevicesSelect() {
                const { $devices } = this
                $devices.innerHTML = ''
                for (let device of Devices) {
                    let option = document.createElement('option')
                    option.value = device.did
                    option.setAttribute('dname', device.name)
                    option.innerHTML = `${device.name} (${device.did})`
                    $devices.appendChild(option)
                }
            }
            _selectDevice(did) {
                const { $devices } = this
                if (!did || did == 'null') {
                    this._initDevicesSelect()
                    // null option
                    let nullOpt = document.createElement('option')
                    nullOpt.value = 'null'
                    nullOpt.innerHTML = 'Select a device'
                    nullOpt.disabled = true
                    nullOpt.selected = true
                    $devices.setAttribute('dname', '')
                    $devices.prepend(nullOpt)
                    return
                }
                if (this.action === 'edit') {
                    $devices.innerHTML = ''
                    let device = Devices.find(device => device.did === did)
                    if (!device) return
                    let option = document.createElement('option')
                    option.value = device.did
                    option.innerHTML = `${device.name} (${device.did})`
                    option.disabled = true
                    option.selected = true
                    $devices.appendChild(option)
                    $devices.setAttribute('dname', device.name)
                } else {
                    $devices.value = did
                    $devices.setAttribute('dname', $devices.querySelector(`option[value="${did}"]`)?.getAttribute('dname'))
                }
            }
            _getDevice() {
                return this.$devices?.value || this.$devices.querySelector('option[disabled]')?.value
            }

            _intPropsSelect() {
                const { $props } = this
                $props.innerHTML = ''
                let did = this._getDevice()
                if (!did || did == 'null') {
                    let nullOpt = document.createElement('option')
                    nullOpt.value = 'null'
                    nullOpt.innerHTML = 'Select a device first'
                    nullOpt.disabled = true
                    nullOpt.selected = true
                    $props.prepend(nullOpt)
                    return
                }

                const device = Devices.find(device => device.did === did)
                if (!device) return
                device.props_name.split(',').forEach(prop => {
                    let option = document.createElement('option')
                    option.value = prop
                    option.innerHTML = prop
                    $props.appendChild(option)
                })
            }
            _propSelect(prop) {
                const did = this._getDevice()
                if (!did || did == 'null') return

                const { $props } = this
                if (!prop) {
                    let nullOpt = document.createElement('option')
                    nullOpt.value = 'null'
                    nullOpt.innerHTML = 'Select a property'
                    nullOpt.disabled = true
                    nullOpt.selected = true
                    $props.prepend(nullOpt)
                    return
                }
                $props.querySelectorAll('option').forEach(opt => opt.removeAttribute('selected'))
                $props.querySelector(`[value="${prop}"]`)?.setAttribute('selected', '')
            }
            _getProp() {
                return this.$props.querySelector('option[selected]')?.value
            }

            save() {
                const ndata = {
                    did: this.modal.querySelector('[name="did"]').value,
                    dname: this.modal.querySelector('[name="did"]').getAttribute('dname'),
                    prop: this.modal.querySelector('[name="prop"]').value,
                    value: this.modal.querySelector('[name="value"]').value
                }
                for (const key in ndata) {
                    if (ndata[key] === undefined || ndata[key] === null || ndata[key] === '') {
                        Confirm.show('Please fill all fields', `"${key}" is empty`, 'OK')
                        return
                    }
                }
                Object.assign(this.data, ndata)
                this.data.lastAction = 'save'
                this.destroy()
            }

            delete() {
                this.data.lastAction = 'delete'
                this.destroy()
            }

            discard() {
                this.data.lastAction = 'discard'
                this.destroy()
            }
        }


        class ATEdit extends ATModal {

            static init() {
                // match type select
                let matchTypes = []
                document.querySelectorAll("#atEditModal [name='atMatchType'] .select-option")?.forEach(el => {
                    const opt = document.createElement('li')
                    opt.className = 'dropdown-item pointer'
                    opt.innerHTML = el.innerHTML
                    opt.setAttribute('value', el.getAttribute('value'))
                    matchTypes.push(opt)
                })
                if (matchTypes.length) {
                    const el = document.querySelector("#atEditModal [name='atMatchType']")
                    el.setAttribute('data-bs-toggle', 'dropdown')
                    const menu = document.createElement('div')
                    menu.className = 'dropdown-menu'
                    matchTypes.forEach(opt => {
                        menu.appendChild(opt)
                        opt.addEventListener('click', () => {
                            el.querySelectorAll('.select-option').forEach(opt => opt.removeAttribute('selected'))
                            el.querySelector(`[value="${opt.getAttribute('value')}"]`).setAttribute('selected', '')
                        })
                    })
                    el.parentNode.appendChild(menu)
                }

                // edit item
                document.getElementById("atEditModal").addEventListener('click', (e) => {
                    const el = e.target
                    const item = el.closest('.at-item')
                    if (!item) return
                    const type = item.closest('.card')?.getAttribute('at-type')
                    const action = item.classList.contains('at-new') ? 'add' : (item.classList.contains('at-edit') ? 'edit' : null)
                    if (!type || !action) return
                    const data = {
                        previousModal: ATModal.currentModal,
                        type,
                        index: item.getAttribute('index') || '',
                        dname: item.getAttribute('dname') || '',
                        did: item.getAttribute('did') || '',
                        prop: item.getAttribute('prop') || '',
                        value: item.getAttribute('value') || ''
                    }
                    setTimeout(() => {
                        new ATEditItem(type, action, data)
                    }, 100);
                    if (!isMobile) {
                        ATModal.currentModal?.destroy()
                    }
                })

            }

            constructor(action, data, atObject = null) {
                super()
                ATModal.currentModal = this

                this.modal = document.getElementById('atEditModal')
                this.action = action
                this.data = data || {}
                this.atObject = atObject
                this.$title = this.modal.querySelector('[role="title"]')
                this.$delBtn = this.modal.querySelector('[action="atDelete"]')
                this.$name = this.modal.querySelector('[name="atName"]')
                this.$matchType = this.modal.querySelector('[name="atMatchType"]')
                this.$triggers = this.modal.querySelector('.card[at-type="trigger"] .card-body')
                this.$actions = this.modal.querySelector('.card[at-type="action"] .card-body')

                if (action === 'add') {
                    this.data = {
                        id: '',
                        enabled: true,
                        name: '',
                        matchType: '0',
                        triggers: [],
                        actions: []
                    }
                    this.$delBtn.style.display = 'none'
                    this.$title.textContent = 'Add new automation'
                } else {
                    this.oldData = JSON.parse(JSON.stringify(data)) || {}
                    this.$delBtn.style.display = 'block'
                    this.$title.textContent = 'Edit automation'
                }

                this._load()
                this.$name.value = data.name || ''
                if (!isNaN(Number(data.matchType))) {
                    this.$matchType.querySelectorAll('.select-option').forEach(opt => opt.removeAttribute('selected'))
                    this.$matchType.querySelector(`[value="${data.matchType}"]`)?.setAttribute('selected', '')
                }

                new bootstrap.Modal(this.modal).show()
            }

            // clear all items from HTML then reload data
            _load() {
                this.$triggers.querySelectorAll('.at-item.at-edit').forEach(item => item.remove())
                this.$actions.querySelectorAll('.at-item.at-edit').forEach(item => item.remove())
                this.data.triggers.forEach((trigger, index) => {
                    trigger.index = index
                    this._appendHTML('trigger', trigger)
                })
                this.data.actions.forEach((action, index) => {
                    action.index = index
                    this._appendHTML('action', action)
                })
            }

            // get item by index from HTML
            _get(type, index) {
                let el = this.modal.querySelector(`.card[at-type="${type}"] .at-item.at-edit[index="${index}"]`)
                if (el) {
                    return {
                        el,
                        index: index,
                        did: el.getAttribute('did'),
                        dname: el.getAttribute('dname'),
                        atType: el.getAttribute('type'),
                        prop: el.getAttribute('prop'),
                        value: el.getAttribute('value')
                    }
                }
                return null
            }

            // set item by index to HTML, if not exists, add new
            _set(type, data) {
                let el = this._get(type, data.index)
                if (!el) {
                    this._add(type, data)
                } else {
                    this.data[`${type}s`][data.index] = data
                    el.el.querySelector('.title').innerHTML = data.value
                    el.el.querySelector('.subtitle').innerHTML = `${data.dname} | ${data.prop}`
                    el.el.setAttribute('did', data.did)
                    el.el.setAttribute('type', data.atType)
                    el.el.setAttribute('dname', data.dname)
                    el.el.setAttribute('prop', data.prop)
                    el.el.setAttribute('value', data.value)
                }
            }

            // add new item to HTML, if exists, show error
            _add(type, data) {
                let index = this.data[`${type}s`].findIndex(item => item.did == data.did && item.prop == data.prop && item.value == data.value)
                if (index >= 0) {
                    Confirm.show('Duplicate', 'This item already exists', 'OK')
                    return
                }
                this.data[`${type}s`].push(data)
                data.index = this.data[`${type}s`].length - 1
                this._appendHTML(type, data)
            }

            // append item to HTML
            _appendHTML(type, data) {
                let index = Number(data.index)
                if (isNaN(index)) return
                let el = document.createElement('div')
                el.className = 'at-item at-edit'
                el.setAttribute('index', index)
                el.setAttribute('did', data.did)
                el.setAttribute('type', data.atType)
                el.setAttribute('dname', data.dname)
                el.setAttribute('prop', data.prop)
                el.setAttribute('value', data.value)
                el.innerHTML = `
                    <div class="index">${index + 1}</div>
                    <div class="content">
                        <div class="title">${data.value}</div>
                        <div class="subtitle">${data.dname} | ${data.prop}</div>
                    </div>`
                this.modal.querySelector(`.card[at-type="${type}"] .card-body`).insertBefore(el, this.modal.querySelector(`.card[at-type="${type}"] .card-body .at-new`))
            }

            // remove item from HTML then reload data
            _remove(type, index) {
                this.modal.querySelector(`.card[at-type="${type}"] .at-item.at-edit[index="${index}"]`)?.remove()
                if (this.data[`${type}s`].length) {
                    this.data[`${type}s`].splice(index, 1)
                }
                this._load()
            }

            destroy() {
                ATModal.currentModal = null
                bootstrap.Modal.getInstance(this.modal)?.hide()
                document.querySelectorAll('.modal-backdrop').forEach(m => m.remove())
                this.atObject?.handleChanges(this.data)
            }

            save() {
                const { $name, $triggers, $actions, $matchType, data } = this
                const name = $name.value
                const match = $matchType.querySelector('.select-option[selected]')?.getAttribute('value')
                const triggers = data.triggers
                const actions = data.actions
                if (name == '' || isNaN(match) || triggers.length == 0 || actions.length == 0) {
                    Confirm.show('Please fill all fields', 'Name, match type, triggers and actions are required', 'OK')
                    return
                }
                data.name = name
                data.matchType = match
                // this.sendSaveRequest(data)
                data.lastAction = this.action === 'add' ? 'add' : 'save'
                console.log(data)
                this.destroy()
            }

            discard() {
                if (this.action === 'edit') {
                    this.data = this.oldData
                }
                this.data.lastAction = 'discard'
                this.destroy()
            }

            delete() {
                // this.sendDeleteRequest(this.data)
                this.data.lastAction = 'delete'
                this.destroy()
            }

            handleItemAction(data) {
                console.log(data)

                if (data.lastAction == 'delete') {
                    this._remove(data.type, data.index)
                } else if (data.lastAction == 'save') {
                    this._set(data.type, data)
                }

                new bootstrap.Modal('#atEditModal').show()
                ATModal.currentModal = data.previousModal
            }
        }


        class Automation {

            static load(rawData) {
                let loadAT = []
                //
            }

            static instances = []

            constructor(data) {
                this.data = data || {}
                this.el = null
                this.init()
                Automation.instances.push(this)
            }

            init() {
                if (!this.isValid()) return
                this.el = document.createElement('div')
                this.el.setAttribute('at-id', this.data.id || '')
                this.el.className = 'card card-1 card-at mb-5'
                this.el.innerHTML = `<div class="card-body d-flex align-items-center p-4">
                        <span class="fs-4 fw-medium" role="at-name">${this.data.name}</span>
                        <div class="ms-auto form-check form-check-lg form-switch">
                            <input class="form-check-input" type="checkbox" action="atEnableToggle" ${this.data.enabled ? 'checked' : ''}>
                        </div>
                    </div>`
                this.el.addEventListener('click', (e) => {
                    const action = e.target.getAttribute('action')
                    if (action === 'atEnableToggle') {
                        this.enable(e.target.checked)
                    } else {
                        new ATEdit('edit', this.data, this)
                    }
                })
            }

            HTMLObject() {
                return this.el
            }

            handleChanges(data) {
                this.data = data
                if (data.lastAction == 'delete') {
                    this.remove()
                } else if (data.lastAction == 'save') {
                    console.log('save', data)
                    this.update()
                } else if (data.lastAction == 'discard') {
                    console.log('discard', data)
                    if (!this.el) {
                        // remove instance
                    }
                } else if (data.lastAction == 'add') {
                    console.log('add', data)
                    this.init()
                    this.appendTo($main)
                    this._disableUI()
                    this.add((data) => {
                        if (!data || !data.success || !data.id) {
                            this.el.remove()
                            // remove instance
                            return
                        }
                    })
                }
            }

            _disableUI(disable = true) {
                if (!this.el) return
                if (disable) {
                    this.el.style.opacity = 0.3
                    this.el.style.pointerEvents = 'none'
                } else {
                    this.el.style.opacity = 1
                    this.el.style.pointerEvents = 'auto'
                }
            }

            isValid() {
                return this.data && this.data.name && this.data.triggers && this.data.actions && this.data.triggers.length && this.data.actions.length
            }

            enable(enable = true, callback) {
                if (!this.isValid()) return
                console.log(`enabling AT ${this.data.name}[${this.data.id}] -> ${enable}`)
                this._disableUI()
                const $el = this.el.querySelector('[action="atEnableToggle"]')
                let url = baseURI + '/auto/enable?id=' + this.data.id
                if (!enable) url += '&disable=1'
                GET(url)
                    .then(data => {
                        this._disableUI(false)
                        if (data.success === true) {
                            notify('success', `Automation "${this.data.name}" ${enable ? 'enabled' : 'disabled'} successfully`)
                            this.data.enabled = enable
                        } else {
                            notify('failure', `Failed to ${enable ? 'enable' : 'disable'} automation "${this.data.name}": ${data.message}`)
                            $el.checked = !enable
                        }
                        if (callback) callback(data)
                    })
                    .catch(err => {
                        this._disableUI(false)
                        notify('failure', `Failed to ${enable ? 'enable' : 'disable'} automation "${this.data.name}": ${err.message}`)
                        $el.checked = !enable
                        if (callback) callback(null)
                    })
            }

            remove(callback) {
                if (!this.isValid()) return
                console.log(`removing AT ${this.data.name}[${this.data.id}]`)

                this._disableUI()
                Loading.circle()
                GET(baseURI + '/auto/remove?id=' + this.data.id)
                    .then(data => {
                        Loading.remove()
                        if (data.success === true) {
                            notify('success', `Automation "${this.data.name}" deleted successfully`)
                            this.el.remove()
                            setTimeout(() => location.reload(), 1500)
                        } else {
                            notify('failure', `Failed to delete automation "${this.data.name}": ${data.message}`)
                            this.el.style.opacity = 1
                        }
                        if (callback) callback(data)
                    })
                    .catch(err => {
                        Loading.remove()
                        this._disableUI(false)
                        notify('failure', `Failed to delete automation "${this.data.name}": ${err.message}`)
                        if (callback) callback(null)
                    })
            }

            add(callback) {
                this.update(callback)
            }

            update(callback) {
                if (!this.isValid()) {
                    notify('failure', `Automation "${this.data.name}" is not valid`)
                    if (callback) callback(null)
                    return
                }
                let isAdd = !this.data.id
                const notiStr = isAdd ? 'Add' : 'Updat'

                const { el, data } = this
                this._disableUI()
                let url = baseURI + '/auto/add-update'
                if (data.id) {
                    url += '?id=' + data.id
                }

                // format data
                let dataStr = ''
                dataStr += `${data.enabled ? '1' : '0'}\n`
                dataStr += `${data.name}\n`
                dataStr += `${data.matchType}\n`
                for (const trigger of data.triggers) {
                    if (trigger.atType == '2') {
                        dataStr += `2|${trigger.did}|${trigger.prop}|${trigger.value}\n`
                    }
                }
                dataStr += '\r\n'
                for (const action of data.actions) {
                    if (action.atType == '2') {
                        dataStr += `2|${action.did}|${action.prop}|${action.value}\n`
                    }
                }
                dataStr += '\r\n'

                console.log(`${notiStr}ing AT`, data.name, data.id)
                console.log(url)
                console.log(data)
                console.log(dataStr)

                POST(url, dataStr)
                    .then(jsondata => {
                        this._disableUI(false)
                        let isSuccess = false
                        if (jsondata.success === true) {
                            if (isAdd) {
                                isSuccess = jsondata.id ? true : false
                            } else {
                                isSuccess = true
                            }
                        }
                        if (isSuccess) {
                            notify('success', `Automation "${data.name}" ${notiStr}ed successfully`)
                            try {
                                el.querySelector('[role="at-name"]').textContent = data.name
                                el.querySelector('[action="atEnableToggle"]').checked = data.enabled
                                if (jsondata.id) {
                                    data.id = jsondata.id
                                    el.setAttribute('at-id', jsondata.id)
                                }
                            } catch (e) { }
                        } else {
                            notify('failure', `Failed to update automation "${data.name}": ${jsondata.message}`)
                        }
                        if (callback) callback(jsondata)
                    })
                    .catch(err => {
                        this._disableUI(false)
                        notify('failure', `Failed to update automation "${data.name}": ${err.message}`)
                        if (callback) callback(null)
                    })
            }

            appendTo(parent) {
                parent?.appendChild(this.el)
            }

        }


        baseURI = 'http://192.168.0.88'
        ATModal.init()

        document.querySelector('[action="addAT"]').addEventListener('click', () => {
            const at = new Automation({})
            new ATEdit('add', at.data, at)
        })

        GET(baseURI + '/auto/get')
            .then(data => {
                console.log(data)
                if (!data || !Array.isArray(data) || !data.length) return
                Automations = data
                    .filter(at => {
                        return at.triggers.length && at.triggers.every(t => t.type == '2') && at.actions.length && at.actions.every(a => a.type == '2')
                    })
                    .map(at => {
                        for (const t of at.triggers) {
                            t.atType = t.type
                            t.did = t.first
                            t.dname = Devices.find(d => d.did == t.did)?.name || 'Unknown'
                            t.prop = t.second
                            t.value = t.third
                        }
                        for (const a of at.actions) {
                            a.atType = a.type
                            a.did = a.first
                            a.dname = Devices.find(d => d.did == a.did)?.name || 'Unknown'
                            a.prop = a.second
                            a.value = a.third
                        }
                        return at
                    })
                console.log(Automations)
                Automations.forEach(data => {
                    const el = new Automation(data)
                    el.appendTo($main)
                })
            })
            .catch(err => {
                notify('failure', `Failed to load automations: ${err.message}`)
            })

    </script>

</body>

</html>